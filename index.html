<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Database Diagram Studio</title>
        <style>
            :root {
                --c-cream-50: rgba(252, 252, 249, 1);
                --c-cream-100: rgba(255, 255, 253, 1);
                --c-gray-200: rgba(245, 245, 245, 1);
                --c-slate-500: rgba(98, 108, 113, 1);
                --c-brown-600: rgba(94, 82, 64, 1);
                --c-charcoal-700: rgba(31, 33, 33, 1);
                --c-charcoal-800: rgba(38, 40, 40, 1);
                --c-slate-900: rgba(19, 52, 59, 1);
                --c-teal-300: rgba(50, 184, 198, 1);
                --c-teal-400: rgba(45, 166, 178, 1);
                --c-teal-500: rgba(33, 128, 141, 1);
                --c-teal-600: rgba(29, 116, 128, 1);
                --c-red-400: rgba(255, 84, 89, 1);
                --c-red-500: rgba(192, 21, 47, 1);
                --c-orange-500: rgba(168, 75, 47, 1);
                --bg: var(--c-cream-50);
                --surface: var(--c-cream-100);
                --text: var(--c-slate-900);
                --text2: var(--c-slate-500);
                --primary: var(--c-teal-500);
                --primary-h: var(--c-teal-600);
                --sec: rgba(94, 82, 64, 0.12);
                --sec-h: rgba(94, 82, 64, 0.2);
                --border: rgba(94, 82, 64, 0.2);
                --btn-pt: var(--c-cream-50);
                --err: var(--c-red-500);
                --card: var(--c-cream-100);
                --edbg: #ffffff;
                --cvbg: #f7f7f5;
                --gdot: rgba(80, 80, 80, 0.18);
                --focus: 2px solid var(--primary);
            }
            @media (prefers-color-scheme: dark) {
                :root {
                    --bg: var(--c-charcoal-700);
                    --surface: var(--c-charcoal-800);
                    --text: var(--c-gray-200);
                    --text2: rgba(167, 169, 169, 0.7);
                    --primary: var(--c-teal-300);
                    --primary-h: var(--c-teal-400);
                    --sec: rgba(119, 124, 124, 0.15);
                    --sec-h: rgba(119, 124, 124, 0.25);
                    --border: rgba(119, 124, 124, 0.3);
                    --btn-pt: var(--c-slate-900);
                    --err: var(--c-red-400);
                    --card: var(--c-charcoal-800);
                    --edbg: #1e2022;
                    --cvbg: #0d0f10;
                    --gdot: rgba(180, 180, 180, 0.13);
                }
            }
            [data-theme="dark"] {
                --bg: var(--c-charcoal-700);
                --surface: var(--c-charcoal-800);
                --text: var(--c-gray-200);
                --text2: rgba(167, 169, 169, 0.7);
                --primary: var(--c-teal-300);
                --primary-h: var(--c-teal-400);
                --sec: rgba(119, 124, 124, 0.15);
                --sec-h: rgba(119, 124, 124, 0.25);
                --border: rgba(119, 124, 124, 0.3);
                --btn-pt: var(--c-slate-900);
                --err: var(--c-red-400);
                --card: var(--c-charcoal-800);
                --edbg: #1e2022;
                --cvbg: #0d0f10;
                --gdot: rgba(180, 180, 180, 0.13);
            }
            [data-theme="light"] {
                --bg: var(--c-cream-50);
                --surface: var(--c-cream-100);
                --text: var(--c-slate-900);
                --text2: var(--c-slate-500);
                --primary: var(--c-teal-500);
                --primary-h: var(--c-teal-600);
                --sec: rgba(94, 82, 64, 0.12);
                --sec-h: rgba(94, 82, 64, 0.2);
                --border: rgba(94, 82, 64, 0.2);
                --btn-pt: var(--c-cream-50);
                --err: var(--c-red-500);
                --card: var(--c-cream-100);
                --edbg: #ffffff;
                --cvbg: #f7f7f5;
                --gdot: rgba(80, 80, 80, 0.18);
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                background: var(--bg);
                color: var(--text);
                overflow: hidden;
                height: 100vh;
            }
            .app {
                display: flex;
                flex-direction: column;
                height: 100vh;
            }
            /* toolbar */
            .toolbar {
                background: var(--surface);
                border-bottom: 1px solid var(--border);
                padding: 8px 13px;
                display: flex;
                align-items: center;
                gap: 7px;
                flex-shrink: 0;
                overflow-x: auto;
            }
            .tg {
                display: flex;
                align-items: center;
                gap: 5px;
                padding-right: 9px;
                border-right: 1px solid var(--border);
                flex-shrink: 0;
            }
            .tg:last-child {
                border-right: none;
                margin-left: auto;
            }
            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 6px 11px;
                border-radius: 7px;
                font-size: 12.5px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.15s;
                border: none;
                background: var(--sec);
                color: var(--text);
                gap: 5px;
                white-space: nowrap;
            }
            .btn:hover {
                background: var(--sec-h);
            }
            .btn-p {
                background: var(--primary);
                color: var(--btn-pt);
            }
            .btn-p:hover {
                background: var(--primary-h);
            }
            .btn-i {
                padding: 6px;
                min-width: 32px;
            }
            .btn-on {
                background: rgba(33, 128, 141, 0.18) !important;
                color: var(--primary) !important;
                box-shadow: inset 0 0 0 1.5px var(--primary);
            }
            .btn-mysql {
                background: rgba(0, 117, 143, 0.12);
                color: #00758f;
                border: 1px solid rgba(0, 117, 143, 0.22);
            }
            .btn-mysql:hover {
                background: rgba(0, 117, 143, 0.2);
            }
            .btn-pgsql {
                background: rgba(51, 103, 145, 0.12);
                color: #336791;
                border: 1px solid rgba(51, 103, 145, 0.22);
            }
            .btn-pgsql:hover {
                background: rgba(51, 103, 145, 0.2);
            }
            [data-theme="dark"] .btn-mysql {
                color: #29b8d8;
                background: rgba(41, 184, 216, 0.12);
                border-color: rgba(41, 184, 216, 0.22);
            }
            [data-theme="dark"] .btn-pgsql {
                color: #6fa8dc;
                background: rgba(111, 168, 220, 0.12);
                border-color: rgba(111, 168, 220, 0.22);
            }
            /* layout */
            .main {
                display: flex;
                flex: 1;
                overflow: hidden;
            }
            .epanel {
                width: 40%;
                min-width: 280px;
                max-width: 620px;
                background: var(--card);
                border-right: 1px solid var(--border);
                display: flex;
                flex-direction: column;
            }
            .ehdr {
                padding: 8px 13px;
                background: var(--surface);
                border-bottom: 1px solid var(--border);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
            }
            .etitle {
                font-size: 12.5px;
                font-weight: 600;
            }
            .ewrap {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                min-height: 0;
            }
            #econ {
                flex: 1;
                overflow: hidden;
                position: relative;
                background: var(--edbg);
            }
            .eload {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                gap: 14px;
                color: var(--text2);
                font-size: 12px;
                background: var(--edbg);
            }
            .ldots {
                display: flex;
                gap: 6px;
            }
            .ldot {
                width: 7px;
                height: 7px;
                border-radius: 50%;
                background: var(--primary);
                animation: dp 1.3s ease-in-out infinite;
            }
            .ldot:nth-child(2) {
                animation-delay: 0.2s;
            }
            .ldot:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes dp {
                0%,
                80%,
                100% {
                    opacity: 0.25;
                    transform: scale(0.7);
                }
                40% {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            .errpanel {
                background: rgba(192, 21, 47, 0.07);
                border-top: 2px solid var(--err);
                padding: 9px 13px;
                max-height: 100px;
                overflow-y: auto;
                display: none;
                flex-shrink: 0;
            }
            .errpanel.on {
                display: block;
            }
            .errmsg {
                font-size: 11.5px;
                color: var(--err);
                font-family: monospace;
                margin-bottom: 2px;
            }
            .resizer {
                width: 4px;
                cursor: col-resize;
                background: var(--border);
                flex-shrink: 0;
                transition: background 0.15s;
            }
            .resizer:hover,
            .resizer.active {
                background: var(--primary);
            }
            /* canvas */
            .cpanel {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .ctbar {
                padding: 7px 13px;
                background: var(--surface);
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                gap: 6px;
                flex-shrink: 0;
            }
            .zctrl {
                display: flex;
                align-items: center;
                gap: 5px;
                margin-left: auto;
            }
            .zval {
                font-size: 12px;
                color: var(--text2);
                min-width: 46px;
                text-align: center;
            }
            #ccon {
                flex: 1;
                overflow: auto;
                background: var(--cvbg);
                position: relative;
            }
            #ccon.grid-on {
                background-image: radial-gradient(
                    circle,
                    var(--gdot) 1.5px,
                    transparent 1.5px
                );
                background-size: 20px 20px;
            }
            #cv {
                min-width: 100%;
                min-height: 100%;
                position: relative;
                transform-origin: top left;
            }
            /* tables */
            .tcard {
                position: absolute;
                background: var(--card);
                border: 1.5px solid var(--border);
                border-radius: 9px;
                overflow: hidden;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                min-width: 190px;
                cursor: move;
                user-select: none;
                transition: box-shadow 0.15s;
            }
            .tcard:hover {
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }
            .tcard.dragging {
                box-shadow: 0 12px 32px rgba(0, 0, 0, 0.22);
                opacity: 0.95;
                z-index: 100;
            }
            .thdr {
                background: var(--primary);
                color: var(--btn-pt);
                padding: 8px 12px;
                font-weight: 700;
                font-size: 13px;
            }
            .tbody {
                background: var(--card);
            }
            .tcol {
                padding: 6px 12px;
                border-bottom: 1px solid var(--border);
                font-size: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 6px;
            }
            .tcol:last-child {
                border-bottom: none;
            }
            .cleft {
                display: flex;
                align-items: center;
            }
            .cn {
                font-weight: 600;
                color: var(--text);
                white-space: nowrap;
            }
            .ct {
                color: var(--text2);
                font-size: 11px;
                margin-left: 6px;
                white-space: nowrap;
            }
            .cbadges {
                display: flex;
                gap: 3px;
                flex-shrink: 0;
            }
            .badge {
                padding: 1px 5px;
                border-radius: 3px;
                font-size: 9px;
                font-weight: 700;
                text-transform: uppercase;
            }
            .b-pk {
                background: rgba(33, 128, 141, 0.18);
                color: var(--primary);
            }
            .b-fk {
                background: rgba(168, 75, 47, 0.18);
                color: var(--c-orange-500);
            }
            .b-u {
                background: rgba(94, 82, 64, 0.18);
                color: var(--c-brown-600);
            }
            .b-nn {
                background: rgba(192, 21, 47, 0.12);
                color: var(--err);
            }
            .b-ai {
                background: rgba(52, 211, 153, 0.15);
                color: #059669;
            }
            /* modal */
            .modal {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(4px);
            }
            .modal.on {
                display: flex;
            }
            .mcontent {
                background: var(--surface);
                border-radius: 12px;
                padding: 22px;
                min-width: 420px;
                max-width: 92vw;
                max-height: 90vh;
                overflow: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
            }
            .mhdr {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 18px;
            }
            .mtitle {
                font-size: 16px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .mclose {
                background: none;
                border: none;
                font-size: 22px;
                cursor: pointer;
                color: var(--text2);
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
            }
            .mclose:hover {
                background: var(--sec-h);
            }
            .fg {
                margin-bottom: 13px;
            }
            .fl {
                display: block;
                margin-bottom: 6px;
                font-weight: 500;
                font-size: 12.5px;
                color: var(--text2);
            }
            .fi,
            .fs {
                width: 100%;
                padding: 8px 11px;
                border: 1px solid var(--border);
                border-radius: 7px;
                background: var(--bg);
                color: var(--text);
                font-size: 13px;
            }
            .fi:focus,
            .fs:focus {
                outline: var(--focus);
                border-color: var(--primary);
            }
            .bgrp {
                display: flex;
                gap: 8px;
                margin-top: 18px;
                align-items: center;
            }
            .sqlprev {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--border);
                border-radius: 7px;
                background: var(--edbg);
                color: var(--text);
                font-family: "Courier New", monospace;
                font-size: 11px;
                line-height: 1.55;
                resize: vertical;
                min-height: 150px;
                max-height: 280px;
            }
            .pactions {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: 6px;
            }
            .cfb {
                font-size: 11px;
                color: var(--primary);
                opacity: 0;
                transition: opacity 0.3s;
                font-weight: 600;
            }
            .cfb.on {
                opacity: 1;
            }
            .dbadge {
                display: inline-flex;
                align-items: center;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 11px;
                font-weight: 600;
            }
            .dbadge.my {
                background: rgba(0, 117, 143, 0.12);
                color: #00758f;
            }
            .dbadge.pg {
                background: rgba(51, 103, 145, 0.12);
                color: #336791;
            }
            [data-theme="dark"] .dbadge.my {
                color: #29b8d8;
                background: rgba(41, 184, 216, 0.15);
            }
            [data-theme="dark"] .dbadge.pg {
                color: #6fa8dc;
                background: rgba(111, 168, 220, 0.15);
            }
            /* status */
            .sbar {
                background: var(--surface);
                border-top: 1px solid var(--border);
                padding: 4px 13px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 11px;
                color: var(--text2);
                flex-shrink: 0;
            }
            .si {
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .gdot-ind {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: var(--primary);
                display: none;
            }
            .gdot-ind.on {
                display: inline-block;
            }
            .save-ind {
                font-size: 10px;
                color: var(--primary);
                opacity: 0;
                transition: opacity 0.5s;
            }
            .save-ind.on {
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div class="app">
            <div class="toolbar">
                <div class="tg">
                    <button class="btn btn-i" id="btn-new" title="New">
                        <svg
                            width="15"
                            height="15"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                            />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="12" y1="18" x2="12" y2="12" />
                            <line x1="9" y1="15" x2="15" y2="15" />
                        </svg>
                    </button>
                    <button
                        class="btn btn-i"
                        id="btn-load"
                        title="Load Example"
                    >
                        <svg
                            width="15"
                            height="15"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
                            />
                            <polyline points="13 2 13 9 20 9" />
                        </svg>
                    </button>
                    <button
                        class="btn btn-i"
                        id="btn-open"
                        title="Open File (.dbml or .sql)"
                    >
                        <svg
                            width="15"
                            height="15"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                            />
                        </svg>
                    </button>
                </div>
                <div class="tg">
                    <button class="btn btn-p" id="btn-png">
                        <svg
                            width="13"
                            height="13"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <polyline points="8 17 12 21 16 17" />
                            <line x1="12" y1="12" x2="12" y2="21" />
                            <path
                                d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"
                            /></svg
                        >PNG
                    </button>
                    <button class="btn btn-p" id="btn-pdf">
                        <svg
                            width="13"
                            height="13"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                            />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" /></svg
                        >PDF
                    </button>
                    <button class="btn" id="btn-dbml">
                        <svg
                            width="13"
                            height="13"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                            />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" /></svg
                        >DBML
                    </button>
                    <button class="btn btn-mysql" id="btn-mysql">
                        <svg
                            width="13"
                            height="13"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <ellipse cx="12" cy="5" rx="9" ry="3" />
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                            <path
                                d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"
                            /></svg
                        >MySQL
                    </button>
                    <button class="btn btn-pgsql" id="btn-pgsql">
                        <svg
                            width="13"
                            height="13"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <ellipse cx="12" cy="5" rx="9" ry="3" />
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                            <path
                                d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"
                            /></svg
                        >PostgreSQL
                    </button>
                </div>
                <div class="tg">
                    <button
                        class="btn btn-i"
                        id="btn-layout"
                        title="Auto Layout"
                    >
                        <svg
                            width="15"
                            height="15"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <rect x="3" y="3" width="7" height="7" />
                            <rect x="14" y="3" width="7" height="7" />
                            <rect x="14" y="14" width="7" height="7" />
                            <rect x="3" y="14" width="7" height="7" />
                        </svg>
                    </button>
                    <button
                        class="btn btn-i"
                        id="btn-fit"
                        title="Fit to Screen"
                    >
                        <svg
                            width="15"
                            height="15"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"
                            />
                        </svg>
                    </button>
                </div>
                <div class="tg">
                    <button
                        class="btn btn-i"
                        id="btn-theme"
                        title="Cycle Theme"
                    >
                        <svg
                            width="15"
                            height="15"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            id="theme-icon"
                        >
                            <path
                                d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                            />
                        </svg>
                    </button>
                    <span
                        id="theme-lbl"
                        style="
                            font-size: 11px;
                            color: var(--text2);
                            min-width: 26px;
                        "
                        >Auto</span
                    >
                </div>
            </div>

            <div class="main">
                <div class="epanel" id="epanel">
                    <div class="ehdr">
                        <div class="etitle">DBML Editor</div>
                        <div
                            style="display: flex; gap: 4px; align-items: center"
                        >
                            <span
                                id="estatus"
                                style="font-size: 11px; color: var(--err)"
                            ></span>
                            <button
                                class="btn btn-i"
                                id="btn-validate"
                                title="Validate"
                            >
                                <svg
                                    width="13"
                                    height="13"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="ewrap">
                        <div id="econ">
                            <div class="eload" id="eload">
                                <div class="ldots">
                                    <div class="ldot"></div>
                                    <div class="ldot"></div>
                                    <div class="ldot"></div>
                                </div>
                                <span>Loading Monaco Editor…</span>
                            </div>
                        </div>
                    </div>
                    <div class="errpanel" id="errpanel"></div>
                </div>

                <div class="resizer" id="resizer"></div>

                <div class="cpanel">
                    <div class="ctbar">
                        <span style="font-weight: 600; font-size: 13px"
                            >Database Diagram</span
                        >
                        <button
                            class="btn btn-i"
                            id="btn-grid"
                            title="Toggle Grid Snapping (G)"
                        >
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <circle cx="4" cy="4" r="1.6" />
                                <circle cx="12" cy="4" r="1.6" />
                                <circle cx="20" cy="4" r="1.6" />
                                <circle cx="4" cy="12" r="1.6" />
                                <circle cx="12" cy="12" r="1.6" />
                                <circle cx="20" cy="12" r="1.6" />
                                <circle cx="4" cy="20" r="1.6" />
                                <circle cx="12" cy="20" r="1.6" />
                                <circle cx="20" cy="20" r="1.6" />
                            </svg>
                        </button>
                        <div class="zctrl">
                            <button
                                class="btn btn-i"
                                id="btn-zout"
                                title="Zoom Out"
                            >
                                <svg
                                    width="13"
                                    height="13"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <circle cx="11" cy="11" r="8" />
                                    <line x1="8" y1="11" x2="14" y2="11" />
                                    <line
                                        x1="21"
                                        y1="21"
                                        x2="16.65"
                                        y2="16.65"
                                    />
                                </svg>
                            </button>
                            <span class="zval" id="zval">100%</span>
                            <button
                                class="btn btn-i"
                                id="btn-zin"
                                title="Zoom In"
                            >
                                <svg
                                    width="13"
                                    height="13"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <circle cx="11" cy="11" r="8" />
                                    <line x1="11" y1="8" x2="11" y2="14" />
                                    <line x1="8" y1="11" x2="14" y2="11" />
                                    <line
                                        x1="21"
                                        y1="21"
                                        x2="16.65"
                                        y2="16.65"
                                    />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="ccon"><div id="cv"></div></div>
                </div>
            </div>

            <div class="sbar">
                <div class="si">
                    <span id="s-tables">0 tables</span><span>•</span>
                    <span id="s-rels">0 relationships</span><span>•</span>
                    <span id=""
                        >Database Diagram Studio (v1.0) &copy
                        <a href="https://smsk.dev">devsimsek</a></span
                    >
                    <span class="gdot-ind" id="gdot"></span>
                    <span
                        id="glbl"
                        style="
                            display: none;
                            font-size: 10px;
                            color: var(--primary);
                        "
                        >Grid ON · 20px</span
                    >
                </div>
                <div class="si"><span id="s-cur">Ln 1, Col 1</span><span class="save-ind" id="save-ind" style="margin-left:8px">● Saved</span></div>
            </div>
        </div>

        <!-- Hidden file input for Open File -->
        <input type="file" id="file-input" accept=".dbml,.sql" style="display:none" />

        <!-- Export Modal -->
        <div class="modal" id="modal">
            <div class="mcontent">
                <div class="mhdr">
                    <h3 class="mtitle" id="mtitle">Export</h3>
                    <button class="mclose" onclick="closeModal()">
                        &times;
                    </button>
                </div>
                <div class="fg">
                    <label class="fl">Filename</label>
                    <input
                        type="text"
                        class="fi"
                        id="exp-fn"
                        value="database-diagram"
                    />
                </div>
                <div class="fg" id="scale-grp">
                    <label class="fl">Scale / Quality</label>
                    <select class="fs" id="exp-scale">
                        <option value="1">1x — Standard</option>
                        <option value="2" selected>2x — Retina</option>
                        <option value="3">3x — High Quality</option>
                        <option value="4">4x — Print Quality</option>
                    </select>
                </div>
                <div class="fg" id="sql-grp" style="display: none">
                    <label class="fl">SQL Preview</label>
                    <textarea
                        class="sqlprev"
                        id="sql-prev"
                        readonly
                        spellcheck="false"
                    ></textarea>
                    <div class="pactions">
                        <button
                            class="btn"
                            id="btn-copy"
                            style="font-size: 12px; padding: 5px 10px"
                        >
                            <svg
                                width="12"
                                height="12"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <rect
                                    x="9"
                                    y="9"
                                    width="13"
                                    height="13"
                                    rx="2"
                                />
                                <path
                                    d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                                /></svg
                            >Copy SQL
                        </button>
                        <span class="cfb" id="cfb">✓ Copied</span>
                    </div>
                </div>
                <div class="bgrp">
                    <button class="btn" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-p" id="btn-expok">
                        <svg
                            width="13"
                            height="13"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                            />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" /></svg
                        >Download
                    </button>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        <!-- IMPORTANT: MonacoEnvironment must be defined BEFORE loader.js is loaded -->
        <script>
            // Blob-URL worker: works on file://, http://, https:// — no importScripts needed
            window.MonacoEnvironment = {
                getWorkerUrl: function () {
                    return URL.createObjectURL(
                        new Blob(["self.onmessage=function(){}"], {
                            type: "application/javascript",
                        }),
                    );
                },
            };
        </script>
        <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>

        <script>
            // ══════════════════════════════════════════════
            // STATE
            // ══════════════════════════════════════════════
            const GRID = 20;
            const ST = {
                tables: [],
                rels: [],
                zoom: 1,
                theme: "auto",
                expType: "png",
                grid: false,
            };
            let ED = null; // Monaco editor instance
            const CV = document.getElementById("cv");
            const EP = document.getElementById("errpanel");

            function getVal() {
                return ED ? ED.getValue() : "";
            }

            // ══════════════════════════════════════════════
            // LOCAL STORAGE AUTO-SAVE
            // ══════════════════════════════════════════════
            const LS_KEY = "dds-workspace";
            let _saveTimer = null;

            function saveToLS() {
                try {
                    localStorage.setItem(LS_KEY, getVal());
                } catch (e) {
                    console.warn("DDS: localStorage save failed:", e);
                }
                const ind = document.getElementById("save-ind");
                if (ind) {
                    ind.classList.add("on");
                    clearTimeout(ind._t);
                    ind._t = setTimeout(
                        () => ind.classList.remove("on"),
                        2000,
                    );
                }
            }

            function scheduleSave() {
                clearTimeout(_saveTimer);
                _saveTimer = setTimeout(saveToLS, 800);
            }

            // ══════════════════════════════════════════════
            // GRID
            // ══════════════════════════════════════════════
            function snap(v) {
                return ST.grid ? Math.round(v / GRID) * GRID : Math.round(v);
            }

            function toggleGrid() {
                ST.grid = !ST.grid;
                const cc = document.getElementById("ccon");
                cc.classList.toggle("grid-on", ST.grid);
                document
                    .getElementById("btn-grid")
                    .classList.toggle("btn-on", ST.grid);
                document.getElementById("gdot").classList.toggle("on", ST.grid);
                const gl = document.getElementById("glbl");
                gl.style.display = ST.grid ? "inline" : "none";
                if (ST.grid) {
                    document.querySelectorAll(".tcard").forEach((c) => {
                        c.style.left = snap(parseInt(c.style.left) || 0) + "px";
                        c.style.top = snap(parseInt(c.style.top) || 0) + "px";
                    });
                    redrawSVG();
                }
            }

            // ══════════════════════════════════════════════
            // DBML PARSER
            // ══════════════════════════════════════════════
            function parseDBML(src) {
                const tables = [],
                    rels = [],
                    errors = [];
                try {
                    let cur = null,
                        inTbl = false,
                        ln = 0;
                    for (const line of src.split("\n")) {
                        ln++;
                        const t = line.trim();
                        if (
                            !t ||
                            t.startsWith("//") ||
                            t.startsWith("/*") ||
                            t.startsWith("*")
                        )
                            continue;
                        if (/^Table\s+/i.test(t)) {
                            const m = t.match(
                                /Table\s+([\w.]+)(?:\s+as\s+\w+)?\s*(?:\[([^\]]*)\])?\s*\{?/i,
                            );
                            if (m) {
                                const hc = (m[2] || "").match(
                                    /headercolor\s*:\s*([#\w]+)/i,
                                );
                                cur = {
                                    name: m[1],
                                    cols: [],
                                    hc: hc ? hc[1] : null,
                                    x: snap(50 + (tables.length % 3) * 300),
                                    y: snap(
                                        50 +
                                            Math.floor(tables.length / 3) * 260,
                                    ),
                                };
                                inTbl = true;
                            }
                        } else if (t === "}" && inTbl) {
                            if (cur) tables.push(cur);
                            cur = null;
                            inTbl = false;
                        } else if (inTbl && cur) {
                            if (
                                /^(Note|indexes|checks)\s*[:{]/i.test(t) ||
                                t.startsWith("~")
                            )
                                continue;
                            const m = t.match(
                                /^([\w"]+)\s+([^\[]+?)(?:\s*\[([^\]]+)\])?\s*$/,
                            );
                            if (m) {
                                const s = m[3] || "",
                                    pk = /\bpk\b|\bprimary\s+key\b/i.test(s);
                                const dm = s.match(
                                    /default\s*:\s*(`[^`]*`|'[^']*'|[\w.+-]+)/i,
                                );
                                cur.cols.push({
                                    name: m[1].replace(/"/g, ""),
                                    type: m[2].trim(),
                                    pk,
                                    uq: /\bunique\b/i.test(s),
                                    fk: /\bref\s*:/i.test(s),
                                    ai: /\bincrement\b/i.test(s),
                                    nn: /\bnot\s+null\b/i.test(s) || pk,
                                    dv: dm ? dm[1] : null,
                                });
                                const rre = /ref\s*:\s*([<>\-]+)\s*([\w.]+)/gi;
                                let rm;
                                while ((rm = rre.exec(s)) !== null)
                                    rels.push({
                                        from: `${cur.name}.${m[1].replace(/"/g, "")}`,
                                        to: rm[2],
                                        type: rm[1].trim(),
                                    });
                            }
                        } else if (/^Ref\s*[\w:]/i.test(t)) {
                            const m = t.match(
                                /Ref\s*(?:\w+\s*)?:?\s*([\w.]+)\s*([<>\-]+)\s*([\w.]+)/i,
                            );
                            if (m)
                                rels.push({
                                    from: m[1],
                                    to: m[3],
                                    type: m[2].trim(),
                                });
                        }
                    }
                } catch (e) {
                    errors.push({ msg: e.message });
                }
                return { tables, rels, errors };
            }

            // ══════════════════════════════════════════════
            // SQL GENERATION
            // ══════════════════════════════════════════════
            function genSQL(dialect) {
                const { tables, rels } = parseDBML(getVal());
                if (!tables.length) return "-- No tables found.\n";
                const my = dialect === "mysql",
                    q = my ? "`" : '"';
                const now = new Date()
                    .toISOString()
                    .replace("T", " ")
                    .slice(0, 19);
                let s = `-- ============================================================\n-- ${my ? "MySQL" : "PostgreSQL"} Schema  •  ${now} UTC\n-- Tables: ${tables.map((t) => t.name).join(", ")}\n-- ============================================================\n\n`;
                s += my
                    ? `SET NAMES utf8mb4;\nSET FOREIGN_KEY_CHECKS = 0;\n\n`
                    : `SET session_replication_role = 'replica';\n\n`;
                function mt(r, inc) {
                    const t = r.toLowerCase().trim();
                    if (my) {
                        if (inc) return "INT";
                        const m = {
                            integer: "INT",
                            int: "INT",
                            biginteger: "BIGINT",
                            bigint: "BIGINT",
                            smallinteger: "SMALLINT",
                            smallint: "SMALLINT",
                            tinyinteger: "TINYINT",
                            tinyint: "TINYINT",
                            boolean: "TINYINT(1)",
                            bool: "TINYINT(1)",
                            float: "FLOAT",
                            real: "FLOAT",
                            double: "DOUBLE",
                            "double precision": "DOUBLE",
                            date: "DATE",
                            time: "TIME",
                            datetime: "DATETIME",
                            timestamp: "TIMESTAMP",
                            json: "JSON",
                            uuid: "CHAR(36)",
                            blob: "BLOB",
                            text: "TEXT",
                            longtext: "LONGTEXT",
                            mediumtext: "MEDIUMTEXT",
                            tinytext: "TINYTEXT",
                        };
                        if (m[t]) return m[t];
                        if (
                            t.startsWith("decimal") ||
                            t.startsWith("numeric") ||
                            t.startsWith("varchar") ||
                            t.startsWith("char") ||
                            t.startsWith("enum")
                        )
                            return r.toUpperCase();
                        return r.toUpperCase();
                    } else {
                        if (inc) return "SERIAL";
                        const m = {
                            integer: "INTEGER",
                            int: "INTEGER",
                            biginteger: "BIGINT",
                            bigint: "BIGINT",
                            smallinteger: "SMALLINT",
                            smallint: "SMALLINT",
                            tinyinteger: "SMALLINT",
                            tinyint: "SMALLINT",
                            boolean: "BOOLEAN",
                            bool: "BOOLEAN",
                            float: "REAL",
                            real: "REAL",
                            double: "DOUBLE PRECISION",
                            "double precision": "DOUBLE PRECISION",
                            date: "DATE",
                            time: "TIME",
                            datetime: "TIMESTAMP",
                            timestamp: "TIMESTAMP",
                            json: "JSONB",
                            jsonb: "JSONB",
                            uuid: "UUID",
                            blob: "BYTEA",
                            text: "TEXT",
                            longtext: "TEXT",
                            mediumtext: "TEXT",
                            tinytext: "TEXT",
                        };
                        if (m[t]) return m[t];
                        if (
                            t.startsWith("decimal") ||
                            t.startsWith("numeric") ||
                            t.startsWith("varchar") ||
                            t.startsWith("char")
                        )
                            return r.toUpperCase();
                        return r.toUpperCase();
                    }
                }
                function fd(v) {
                    if (!v) return null;
                    if (v.startsWith("`") && v.endsWith("`")) {
                        const x = v.slice(1, -1);
                        return my
                            ? x.toLowerCase() === "now()"
                                ? "CURRENT_TIMESTAMP"
                                : x
                            : x;
                    }
                    if (v.startsWith("'")) return v;
                    const lo = v.toLowerCase();
                    if (lo === "null") return "NULL";
                    if (lo === "true") return my ? "1" : "TRUE";
                    if (lo === "false") return my ? "0" : "FALSE";
                    if (/^-?\d+(\.\d+)?$/.test(v)) return v;
                    return `'${v}'`;
                }
                tables.forEach((tbl) => {
                    s += `-- Table: ${tbl.name}\n`;
                    s += my
                        ? `DROP TABLE IF EXISTS ${q}${tbl.name}${q};\n`
                        : `DROP TABLE IF EXISTS ${q}${tbl.name}${q} CASCADE;\n`;
                    s += `CREATE TABLE ${q}${tbl.name}${q} (\n`;
                    const cd = [],
                        pk = [];
                    tbl.cols.forEach((c) => {
                        let d = `  ${q}${c.name}${q} ${mt(c.type, c.ai)}`;
                        if (c.ai && my) d += " AUTO_INCREMENT";
                        if (c.nn || c.pk) d += " NOT NULL";
                        if (c.dv) {
                            const dv = fd(c.dv);
                            if (dv) d += ` DEFAULT ${dv}`;
                        }
                        if (c.uq && !c.pk) d += " UNIQUE";
                        cd.push(d);
                        if (c.pk) pk.push(`${q}${c.name}${q}`);
                    });
                    if (pk.length)
                        cd.push(
                            `  CONSTRAINT ${q}pk_${tbl.name}${q} PRIMARY KEY (${pk.join(", ")})`,
                        );
                    s += cd.join(",\n");
                    s += my
                        ? `\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n`
                        : `\n);\n\n`;
                });
                const fks = rels.filter(
                    (r) => r.from.includes(".") && r.to.includes("."),
                );
                if (fks.length) {
                    s += `-- Foreign Key Constraints\n\n`;
                    fks.forEach((r) => {
                        const [ft, fc] = r.from.split("."),
                            [tt, tc] = r.to.split(".");
                        const [fT, fC, tT, tC] =
                            r.type !== "<"
                                ? [ft, fc, tt, tc]
                                : [tt, tc, ft, fc];
                        s += `ALTER TABLE ${q}${fT}${q}\n  ADD CONSTRAINT ${q}fk_${fT}_${fC}${q}\n  FOREIGN KEY (${q}${fC}${q})\n  REFERENCES ${q}${tT}${q} (${q}${tC}${q})\n  ON DELETE RESTRICT ON UPDATE CASCADE;\n\n`;
                    });
                }
                s += my
                    ? `SET FOREIGN_KEY_CHECKS = 1;\n`
                    : `SET session_replication_role = 'origin';\n`;
                return s;
            }

            // ══════════════════════════════════════════════
            // SQL → DBML IMPORT
            // ══════════════════════════════════════════════
            function splitColDefs(body) {
                const parts = [];
                let depth = 0,
                    cur = "";
                for (const ch of body) {
                    if (ch === "(") depth++;
                    else if (ch === ")") depth--;
                    if (ch === "," && depth === 0) {
                        parts.push(cur.trim());
                        cur = "";
                    } else {
                        cur += ch;
                    }
                }
                if (cur.trim()) parts.push(cur.trim());
                return parts;
            }

            function normalizeSQLType(t) {
                const tu = t.toUpperCase().trim();
                const map = {
                    INT: "integer",
                    "INT UNSIGNED": "integer",
                    INTEGER: "integer",
                    BIGINT: "biginteger",
                    "BIGINT UNSIGNED": "biginteger",
                    SMALLINT: "smallinteger",
                    "SMALLINT UNSIGNED": "smallinteger",
                    TINYINT: "tinyinteger",
                    "TINYINT(1)": "boolean",
                    BOOL: "boolean",
                    BOOLEAN: "boolean",
                    FLOAT: "float",
                    REAL: "real",
                    DOUBLE: "double",
                    "DOUBLE PRECISION": "double",
                    DATE: "date",
                    TIME: "time",
                    DATETIME: "datetime",
                    TIMESTAMP: "timestamp",
                    "TIMESTAMP WITHOUT TIME ZONE": "timestamp",
                    "TIMESTAMP WITH TIME ZONE": "timestamp",
                    TIMESTAMPTZ: "timestamp",
                    JSON: "json",
                    JSONB: "jsonb",
                    TEXT: "text",
                    LONGTEXT: "longtext",
                    MEDIUMTEXT: "mediumtext",
                    TINYTEXT: "tinytext",
                    BLOB: "blob",
                    BYTEA: "blob",
                    UUID: "uuid",
                    "CHAR(36)": "uuid",
                    SERIAL: "integer",
                    BIGSERIAL: "biginteger",
                    SMALLSERIAL: "smallinteger",
                    "CHARACTER VARYING": "varchar",
                };
                if (map[tu]) return map[tu];
                return t.toLowerCase();
            }

            function sqlToDBML(sql) {
                sql = sql
                    .replace(/\r\n/g, "\n")
                    .replace(/\r/g, "\n");
                // Remove block comments
                sql = sql.replace(/\/\*[\s\S]*?\*\//g, " ");
                // Remove line comments
                sql = sql.replace(/--[^\n]*/g, "");

                const tables = [];
                const fkRels = [];

                // Find CREATE TABLE statements using bracket matching
                const ctRe =
                    /CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?/gi;
                let ctMatch;
                while ((ctMatch = ctRe.exec(sql)) !== null) {
                    const startIdx =
                        ctMatch.index + ctMatch[0].length;
                    const namePart = sql.slice(startIdx);
                    const nameMatch = namePart.match(
                        /^(?:`([^`]+)`|"([^"]+)"|(\w+))\s*\(/,
                    );
                    if (!nameMatch) continue;
                    const tableName =
                        nameMatch[1] || nameMatch[2] || nameMatch[3];

                    // Find body between matching parentheses
                    const parenStart =
                        startIdx + namePart.indexOf("(");
                    let depth = 0,
                        i = parenStart;
                    for (; i < sql.length; i++) {
                        if (sql[i] === "(") depth++;
                        else if (sql[i] === ")") {
                            depth--;
                            if (depth === 0) break;
                        }
                    }
                    const body = sql.slice(parenStart + 1, i);
                    const parts = splitColDefs(body);

                    const cols = [];
                    const tablePKs = [];
                    const tableUniques = [];

                    parts.forEach((part) => {
                        part = part.trim();
                        if (!part) return;

                        // Skip plain KEY/INDEX definitions
                        if (/^(KEY|INDEX)\s/i.test(part)) return;

                        // PRIMARY KEY table constraint
                        if (
                            /^(CONSTRAINT\s+\S+\s+)?PRIMARY\s+KEY\s*\(/i.test(
                                part,
                            )
                        ) {
                            const pkm = part.match(
                                /PRIMARY\s+KEY\s*\(([^)]+)\)/i,
                            );
                            if (pkm)
                                pkm[1]
                                    .split(",")
                                    .forEach((c) =>
                                        tablePKs.push(
                                            c
                                                .trim()
                                                .replace(/[`"]/g, ""),
                                        ),
                                    );
                            return;
                        }

                        // UNIQUE table constraint
                        // Matches: [CONSTRAINT name] UNIQUE [KEY|INDEX] [index_name] (col, ...)
                        if (
                            /^(CONSTRAINT\s+\S+\s+)?UNIQUE\s*(?:KEY|INDEX)?\s*(?:`[^`]+`|"\w+"|\w+)?\s*\(/i.test(
                                part,
                            )
                        ) {
                            const um = part.match(
                                /UNIQUE\s*(?:KEY|INDEX)?\s*(?:`[^`]+`|"\w+"|\w+)?\s*\(([^)]+)\)/i,
                            );
                            if (um) {
                                const ucols = um[1]
                                    .split(",")
                                    .map((c) =>
                                        c.trim().replace(/[`"]/g, ""),
                                    );
                                if (ucols.length === 1)
                                    tableUniques.push(ucols[0]);
                            }
                            return;
                        }

                        // FOREIGN KEY table constraint
                        if (
                            /^(CONSTRAINT\s+\S+\s+)?FOREIGN\s+KEY/i.test(
                                part,
                            )
                        ) {
                            const fkm = part.match(
                                /FOREIGN\s+KEY\s*\(([^)]+)\)\s*REFERENCES\s*(?:`([^`]+)`|"([^"]+)"|(\w+))\s*\(([^)]+)\)/i,
                            );
                            if (fkm) {
                                const fromCol = fkm[1]
                                    .trim()
                                    .replace(/[`"]/g, "");
                                const toTable =
                                    fkm[2] || fkm[3] || fkm[4];
                                const toCol = fkm[5]
                                    .trim()
                                    .replace(/[`"]/g, "");
                                fkRels.push({
                                    from: `${tableName}.${fromCol}`,
                                    to: `${toTable}.${toCol}`,
                                });
                            }
                            return;
                        }

                        // CHECK constraint
                        if (
                            /^(CONSTRAINT\s+\S+\s+)?CHECK\s*\(/i.test(
                                part,
                            )
                        )
                            return;

                        // Column definition
                        const colm = part.match(
                            /^(?:`([^`]+)`|"([^"]+)"|(\w+))\s+(.+)$/is,
                        );
                        if (!colm) return;
                        const colName =
                            colm[1] || colm[2] || colm[3];
                        const skipKw = [
                            "PRIMARY",
                            "UNIQUE",
                            "KEY",
                            "INDEX",
                            "CONSTRAINT",
                            "FOREIGN",
                            "CHECK",
                        ];
                        if (
                            skipKw.includes(colName.toUpperCase())
                        )
                            return;

                        const rest = colm[4];
                        // Extract type (handles parens like VARCHAR(255), DECIMAL(10,2))
                        const typeMatch = rest.match(
                            /^(\w+(?:\s*\([^)]*\))?)/i,
                        );
                        let colType = typeMatch
                            ? typeMatch[1].trim()
                            : rest.split(/\s/)[0];
                        const restAfter = rest.slice(
                            colType.length,
                        );

                        const isSerial =
                            /^(BIGSERIAL|SMALLSERIAL|SERIAL)$/i.test(
                                colType,
                            );
                        const isPK =
                            /\bPRIMARY\s+KEY\b/i.test(restAfter);
                        const isNN =
                            /\bNOT\s+NULL\b/i.test(restAfter) ||
                            isPK ||
                            isSerial;
                        const isUQ =
                            /\bUNIQUE\b/i.test(restAfter);
                        const isAI =
                            /\bAUTO_INCREMENT\b/i.test(
                                restAfter,
                            ) || isSerial;

                        // Default value (handles standard SQL string escaping with '')
                        let defVal = null;
                        const defm = restAfter.match(
                            /\bDEFAULT\s+(`[^`]*`|'(?:[^']|'')*'|-?\d+(?:\.\d+)?|NULL|TRUE|FALSE|CURRENT_TIMESTAMP(?:\(\))?|\w+(?:\(\))?)/i,
                        );
                        if (defm) {
                            defVal = defm[1];
                            if (
                                /^CURRENT_TIMESTAMP/i.test(defVal)
                            )
                                defVal = "`now()`";
                            else if (
                                /^(NULL|TRUE|FALSE)$/i.test(defVal)
                            )
                                defVal = defVal.toLowerCase();
                        }

                        if (isPK) tablePKs.push(colName);

                        // Inline REFERENCES (PostgreSQL column-level FK)
                        const inlineRef = restAfter.match(
                            /\bREFERENCES\s+(?:`([^`]+)`|"([^"]+)"|(\w+))\s*\(([^)]+)\)/i,
                        );
                        if (inlineRef) {
                            const toTable =
                                inlineRef[1] ||
                                inlineRef[2] ||
                                inlineRef[3];
                            const toCol = inlineRef[4]
                                .trim()
                                .replace(/[`"]/g, "");
                            fkRels.push({
                                from: `${tableName}.${colName}`,
                                to: `${toTable}.${toCol}`,
                            });
                        }

                        cols.push({
                            name: colName,
                            type: normalizeSQLType(colType),
                            pk: isPK,
                            nn: isNN,
                            uq: isUQ,
                            ai: isAI,
                            dv: defVal,
                        });
                    });

                    // Apply table-level PRIMARY KEY and UNIQUE
                    cols.forEach((c) => {
                        if (tablePKs.includes(c.name)) {
                            c.pk = true;
                            c.nn = true;
                        }
                        if (tableUniques.includes(c.name))
                            c.uq = true;
                    });

                    if (tableName && cols.length)
                        tables.push({ name: tableName, cols });
                }

                // Parse ALTER TABLE … ADD FOREIGN KEY
                const alterRe =
                    /ALTER\s+TABLE\s+(?:`([^`]+)`|"([^"]+)"|(\w+))\s+ADD\s+(?:CONSTRAINT\s+(?:`[^`]+`|"\w+"|\S+)\s+)?FOREIGN\s+KEY\s*\(([^)]+)\)\s*REFERENCES\s*(?:`([^`]+)`|"([^"]+)"|(\w+))\s*\(([^)]+)\)/gi;
                let altm;
                while ((altm = alterRe.exec(sql)) !== null) {
                    const fromTable =
                        altm[1] || altm[2] || altm[3];
                    const fromCol = altm[4]
                        .trim()
                        .replace(/[`"]/g, "");
                    const toTable = altm[5] || altm[6] || altm[7];
                    const toCol = altm[8]
                        .trim()
                        .replace(/[`"]/g, "");
                    fkRels.push({
                        from: `${fromTable}.${fromCol}`,
                        to: `${toTable}.${toCol}`,
                    });
                }

                if (!tables.length)
                    return "// No tables found in SQL file\n";

                let dbml = "// Imported from SQL\n\n";
                tables.forEach((t) => {
                    dbml += `Table ${t.name} {\n`;
                    t.cols.forEach((c) => {
                        const attrs = [];
                        if (c.pk) attrs.push("pk");
                        if (c.ai) attrs.push("increment");
                        if (c.nn && !c.pk) attrs.push("not null");
                        if (c.uq && !c.pk) attrs.push("unique");
                        if (c.dv !== null)
                            attrs.push(`default: ${c.dv}`);
                        const fk = fkRels.find(
                            (r) => r.from === `${t.name}.${c.name}`,
                        );
                        if (fk) attrs.push(`ref: > ${fk.to}`);
                        dbml += `  ${c.name} ${c.type}`;
                        if (attrs.length)
                            dbml += ` [${attrs.join(", ")}]`;
                        dbml += "\n";
                    });
                    dbml += "}\n\n";
                });
                return dbml.trimEnd() + "\n";
            }

            // ══════════════════════════════════════════════
            // FILE IMPORT
            // ══════════════════════════════════════════════
            function openFile() {
                document.getElementById("file-input").click();
            }

            document
                .getElementById("file-input")
                .addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        if (!ED) return;
                        const content = ev.target.result;
                        const name = file.name.toLowerCase();
                        let dbml = content;
                        if (name.endsWith(".sql")) {
                            dbml = sqlToDBML(content);
                        }
                        ED.setValue(dbml);
                        ED.setPosition({ lineNumber: 1, column: 1 });
                        render();
                    };
                    reader.readAsText(file);
                    // Reset so the same file can be re-opened
                    this.value = "";
                });


            function render() {
                const res = parseDBML(getVal());
                ST.tables = res.tables;
                ST.rels = res.rels;
                res.errors.length ? showErr(res.errors) : hideErr();
                CV.innerHTML = "";
                const cw = Math.max(
                    1200,
                    ...ST.tables.map((t) => t.x + 300),
                    100,
                );
                const ch = Math.max(
                    800,
                    ...ST.tables.map((t) => t.y + 280),
                    100,
                );
                CV.style.width = cw + "px";
                CV.style.height = ch + "px";
                const svg = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "svg",
                );
                svg.style.cssText =
                    "position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;";
                CV.appendChild(svg);
                ST.tables.forEach((t) => CV.appendChild(mkCard(t)));
                setTimeout(() => drawRels(svg), 12);
                updateSBar();
            }

            function mkCard(tbl) {
                const card = document.createElement("div");
                card.className = "tcard";
                card.style.cssText = `left:${tbl.x}px;top:${tbl.y}px;`;
                card.dataset.tn = tbl.name;
                const hdr = document.createElement("div");
                hdr.className = "thdr";
                hdr.textContent = tbl.name;
                if (tbl.hc) hdr.style.background = tbl.hc;
                const body = document.createElement("div");
                body.className = "tbody";
                tbl.cols.forEach((c) => {
                    const row = document.createElement("div");
                    row.className = "tcol";
                    const l = document.createElement("div");
                    l.className = "cleft";
                    const n = document.createElement("span");
                    n.className = "cn";
                    n.textContent = c.name;
                    const tp = document.createElement("span");
                    tp.className = "ct";
                    tp.textContent = c.type;
                    l.appendChild(n);
                    l.appendChild(tp);
                    const bs = document.createElement("div");
                    bs.className = "cbadges";
                    if (c.pk) bs.appendChild(mkB("PK", "b-pk"));
                    if (c.fk) bs.appendChild(mkB("FK", "b-fk"));
                    if (c.uq) bs.appendChild(mkB("U", "b-u"));
                    if (c.ai) bs.appendChild(mkB("AI", "b-ai"));
                    if (c.nn && !c.pk) bs.appendChild(mkB("NN", "b-nn"));
                    row.appendChild(l);
                    row.appendChild(bs);
                    body.appendChild(row);
                });
                card.appendChild(hdr);
                card.appendChild(body);
                makeDrag(card);
                return card;
            }

            function mkB(txt, cls) {
                const b = document.createElement("span");
                b.className = `badge ${cls}`;
                b.textContent = txt;
                return b;
            }

            function drawRels(svg) {
                svg.innerHTML = "";
                const ts =
                    getComputedStyle(document.documentElement)
                        .getPropertyValue("--text2")
                        .trim() || "#888";
                const defs = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "defs",
                );
                const mk = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "marker",
                );
                mk.setAttribute("id", "ar");
                mk.setAttribute("markerWidth", "10");
                mk.setAttribute("markerHeight", "7");
                mk.setAttribute("refX", "9");
                mk.setAttribute("refY", "3.5");
                mk.setAttribute("orient", "auto");
                const pl = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "polygon",
                );
                pl.setAttribute("points", "0 0,10 3.5,0 7");
                pl.setAttribute("fill", ts);
                mk.appendChild(pl);
                defs.appendChild(mk);
                svg.appendChild(defs);
                const cr = CV.getBoundingClientRect();
                ST.rels.forEach((r) => {
                    const [ft] = r.from.split("."),
                        [tt] = r.to.split(".");
                    const fe = CV.querySelector(`[data-tn="${ft}"]`),
                        te = CV.querySelector(`[data-tn="${tt}"]`);
                    if (!fe || !te) return;
                    const fr = fe.getBoundingClientRect(),
                        tr = te.getBoundingClientRect();
                    const fx = (fr.left - cr.left + fr.width / 2) / ST.zoom,
                        fy = (fr.top - cr.top + fr.height / 2) / ST.zoom;
                    const tx = (tr.left - cr.left + tr.width / 2) / ST.zoom,
                        ty = (tr.top - cr.top + tr.height / 2) / ST.zoom;
                    const mx = (fx + tx) / 2;
                    const p = document.createElementNS(
                        "http://www.w3.org/2000/svg",
                        "path",
                    );
                    p.setAttribute(
                        "d",
                        `M ${fx} ${fy} C ${mx} ${fy},${mx} ${ty},${tx} ${ty}`,
                    );
                    p.setAttribute("fill", "none");
                    p.setAttribute("stroke", ts);
                    p.setAttribute("stroke-width", "1.8");
                    p.setAttribute(
                        "stroke-dasharray",
                        r.type === "<>" ? "5,4" : "",
                    );
                    p.setAttribute("marker-end", "url(#ar)");
                    svg.appendChild(p);
                });
            }

            function redrawSVG() {
                const s = CV.querySelector("svg");
                if (s) drawRels(s);
            }

            function makeDrag(el) {
                const hdr = el.querySelector(".thdr");
                hdr.addEventListener("mousedown", (e) => {
                    e.preventDefault();
                    const ox = e.clientX - el.offsetLeft,
                        oy = e.clientY - el.offsetTop;
                    el.classList.add("dragging");
                    const mv = (ev) => {
                        el.style.left = snap(ev.clientX - ox) + "px";
                        el.style.top = snap(ev.clientY - oy) + "px";
                        redrawSVG();
                    };
                    const up = () => {
                        el.classList.remove("dragging");
                        document.removeEventListener("mousemove", mv);
                        document.removeEventListener("mouseup", up);
                    };
                    document.addEventListener("mousemove", mv);
                    document.addEventListener("mouseup", up);
                });
            }

            // ══════════════════════════════════════════════
            // STATUS / ERRORS
            // ══════════════════════════════════════════════
            function showErr(errs) {
                EP.innerHTML = "";
                errs.forEach((e) => {
                    const d = document.createElement("div");
                    d.className = "errmsg";
                    d.textContent = `⚠ ${e.msg}`;
                    EP.appendChild(d);
                });
                EP.classList.add("on");
            }
            function hideErr() {
                EP.classList.remove("on");
            }
            function updateSBar() {
                const tc = ST.tables.length,
                    rc = ST.rels.length;
                document.getElementById("s-tables").textContent =
                    `${tc} table${tc !== 1 ? "s" : ""}`;
                document.getElementById("s-rels").textContent =
                    `${rc} relationship${rc !== 1 ? "s" : ""}`;
            }

            // ══════════════════════════════════════════════
            // ZOOM
            // ══════════════════════════════════════════════
            function setZoom(z) {
                ST.zoom = Math.max(0.1, Math.min(3, z));
                CV.style.transform = `scale(${ST.zoom})`;
                document.getElementById("zval").textContent =
                    Math.round(ST.zoom * 100) + "%";
                if (ST.grid) {
                    const s = GRID * ST.zoom;
                    document.getElementById("ccon").style.backgroundSize =
                        `${s}px ${s}px`;
                }
            }

            function autoLayout() {
                ST.tables.forEach((t, i) => {
                    t.x = snap(50 + (i % 3) * 300);
                    t.y = snap(50 + Math.floor(i / 3) * 260);
                });
                render();
            }

            function fitScreen() {
                if (!ST.tables.length) return;
                const cr = document
                    .getElementById("ccon")
                    .getBoundingClientRect();
                const cv = CV.getBoundingClientRect();
                setZoom(
                    Math.min(cr.width / cv.width, cr.height / cv.height, 1) *
                        0.88,
                );
            }

            // ══════════════════════════════════════════════
            // THEME
            // ══════════════════════════════════════════════
            const TCY = ["auto", "dark", "light"];
            const TICO = {
                auto: `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`,
                dark: `<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>`,
                light: `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`,
            };
            function getMonacoTheme() {
                if (ST.theme === "dark") return "dbml-dark";
                if (ST.theme === "light") return "dbml-light";
                return window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "dbml-dark"
                    : "dbml-light";
            }
            function toggleTheme() {
                ST.theme = TCY[(TCY.indexOf(ST.theme) + 1) % TCY.length];
                const html = document.documentElement;
                html.removeAttribute("data-theme");
                if (ST.theme !== "auto")
                    html.setAttribute("data-theme", ST.theme);
                document.getElementById("theme-icon").innerHTML =
                    TICO[ST.theme];
                document.getElementById("theme-lbl").textContent = {
                    auto: "Auto",
                    dark: "Light",
                    light: "Dark",
                }[ST.theme];
                if (ED) window.monaco?.editor.setTheme(getMonacoTheme());
                setTimeout(redrawSVG, 60);
            }

            // ══════════════════════════════════════════════
            // EXAMPLE SCHEMA
            // ══════════════════════════════════════════════
            const EX = `// E-commerce Database Schema
Project ecommerce {
  database_type: 'PostgreSQL'
  Note: 'Online store'
}

Table users [headercolor: #3498DB] {
  id integer [pk, increment]
  username varchar(50) [not null, unique]
  email varchar(100) [not null, unique]
  password_hash varchar(255) [not null]
  first_name varchar(50)
  last_name varchar(50)
  created_at timestamp [default: \`now()\`]
  updated_at timestamp [default: \`now()\`]
}

Table categories [headercolor: #9B59B6] {
  id integer [pk, increment]
  name varchar(100) [not null, unique]
  description text
  parent_id integer [ref: > categories.id]
  created_at timestamp [default: \`now()\`]
}

Table products [headercolor: #E74C3C] {
  id integer [pk, increment]
  name varchar(200) [not null]
  description text
  price decimal(10,2) [not null]
  stock_quantity integer [default: 0]
  category_id integer [ref: > categories.id]
  created_at timestamp [default: \`now()\`]
  updated_at timestamp [default: \`now()\`]
}

Table orders [headercolor: #F39C12] {
  id integer [pk, increment]
  user_id integer [ref: > users.id, not null]
  status varchar(20) [default: 'pending', not null]
  total_amount decimal(10,2) [not null]
  shipping_address text
  created_at timestamp [default: \`now()\`]
  updated_at timestamp [default: \`now()\`]
}

Table order_items [headercolor: #1ABC9C] {
  id integer [pk, increment]
  order_id integer [ref: > orders.id, not null]
  product_id integer [ref: > products.id, not null]
  quantity integer [not null, default: 1]
  unit_price decimal(10,2) [not null]
  subtotal decimal(10,2) [not null]
}

Table reviews [headercolor: #34495E] {
  id integer [pk, increment]
  product_id integer [ref: > products.id, not null]
  user_id integer [ref: > users.id, not null]
  rating integer [not null]
  comment text
  created_at timestamp [default: \`now()\`]
}`;

            function loadEx() {
                if (!ED) return;
                ED.setValue(EX);
                ED.setPosition({ lineNumber: 1, column: 1 });
                render();
            }
            function newDia() {
                if (getVal().trim() && !confirm("Clear diagram?")) return;
                ED?.setValue("");
                try {
                    localStorage.removeItem(LS_KEY);
                } catch (e) {
                    console.warn("DDS: localStorage clear failed:", e);
                }                render();
            }

            // ══════════════════════════════════════════════
            // EXPORT
            // ══════════════════════════════════════════════
            function showModal() {
                const sg = document.getElementById("scale-grp"),
                    spg = document.getElementById("sql-grp");
                const ti = document.getElementById("mtitle"),
                    fn = document.getElementById("exp-fn");
                sg.style.display = "none";
                spg.style.display = "none";
                if (ST.expType === "png") {
                    ti.innerHTML = "Export as PNG";
                    sg.style.display = "block";
                    fn.value = "database-diagram";
                } else if (ST.expType === "pdf") {
                    ti.innerHTML = "Export as PDF";
                    fn.value = "database-diagram";
                } else if (ST.expType === "mysql") {
                    ti.innerHTML =
                        'Export MySQL <span class="dbadge my">MySQL</span>';
                    spg.style.display = "block";
                    fn.value = "schema_mysql";
                    document.getElementById("sql-prev").value = genSQL("mysql");
                } else if (ST.expType === "pgsql") {
                    ti.innerHTML =
                        'Export PostgreSQL <span class="dbadge pg">PostgreSQL</span>';
                    spg.style.display = "block";
                    fn.value = "schema_pgsql";
                    document.getElementById("sql-prev").value = genSQL("pgsql");
                }
                document.getElementById("modal").classList.add("on");
            }
            function closeModal() {
                document.getElementById("modal").classList.remove("on");
            }

            function doExport() {
                const fn =
                    document.getElementById("exp-fn").value ||
                    "database-diagram";
                const sc =
                    parseFloat(document.getElementById("exp-scale").value) || 2;
                closeModal();
                if (ST.expType === "png") expPNG(fn, sc);
                else if (ST.expType === "pdf") expPDF(fn);
                else {
                    const sql = genSQL(ST.expType);
                    const b = new Blob([sql], {
                        type: "text/plain;charset=utf-8",
                    });
                    const u = URL.createObjectURL(b);
                    const a = document.createElement("a");
                    a.href = u;
                    a.download = fn.endsWith(".sql") ? fn : fn + ".sql";
                    a.click();
                    URL.revokeObjectURL(u);
                }
            }

            function expDBML() {
                const fn = prompt("Filename:", "schema.dbml");
                if (!fn) return;
                const b = new Blob([getVal()], { type: "text/plain" });
                const u = URL.createObjectURL(b);
                const a = document.createElement("a");
                a.href = u;
                a.download = fn.endsWith(".dbml") ? fn : fn + ".dbml";
                a.click();
                URL.revokeObjectURL(u);
            }

            function expPNG(fn, sc) {
                const oz = ST.zoom;
                setZoom(1);
                setTimeout(() => {
                    html2canvas(CV, {
                        scale: sc,
                        backgroundColor: getComputedStyle(CV).backgroundColor,
                        logging: false,
                        useCORS: true,
                    }).then((c) => {
                        const a = document.createElement("a");
                        a.download = fn + ".png";
                        a.href = c.toDataURL("image/png");
                        a.click();
                        setZoom(oz);
                    });
                }, 120);
            }
            function expPDF(fn) {
                const oz = ST.zoom;
                setZoom(1);
                setTimeout(() => {
                    html2canvas(CV, {
                        scale: 2,
                        backgroundColor: getComputedStyle(CV).backgroundColor,
                        logging: false,
                        useCORS: true,
                    }).then((c) => {
                        const img = c.toDataURL("image/png");
                        const { jsPDF } = window.jspdf;
                        const r = c.width / c.height;
                        const pdf = new jsPDF({
                            orientation: r > 1 ? "landscape" : "portrait",
                            unit: "mm",
                            format: "a4",
                        });
                        const pw = pdf.internal.pageSize.getWidth(),
                            ph = pdf.internal.pageSize.getHeight();
                        const w = r > 1 ? pw : ph * r,
                            h = r > 1 ? pw / r : ph;
                        pdf.addImage(img, "PNG", 0, 0, w, h);
                        pdf.save(fn + ".pdf");
                        setZoom(oz);
                    });
                }, 120);
            }

            document
                .getElementById("btn-copy")
                .addEventListener("click", () => {
                    navigator.clipboard
                        .writeText(document.getElementById("sql-prev").value)
                        .then(() => {
                            const fb = document.getElementById("cfb");
                            fb.classList.add("on");
                            setTimeout(() => fb.classList.remove("on"), 2000);
                        });
                });

            // ══════════════════════════════════════════════
            // TOOLBAR EVENTS
            // ══════════════════════════════════════════════
            document
                .getElementById("btn-zin")
                .addEventListener("click", () => setZoom(ST.zoom + 0.1));
            document
                .getElementById("btn-zout")
                .addEventListener("click", () => setZoom(ST.zoom - 0.1));
            document
                .getElementById("btn-layout")
                .addEventListener("click", autoLayout);
            document
                .getElementById("btn-fit")
                .addEventListener("click", fitScreen);
            document
                .getElementById("btn-theme")
                .addEventListener("click", toggleTheme);
            document
                .getElementById("btn-new")
                .addEventListener("click", newDia);
            document
                .getElementById("btn-load")
                .addEventListener("click", loadEx);
            document
                .getElementById("btn-open")
                .addEventListener("click", openFile);
            document
                .getElementById("btn-validate")
                .addEventListener("click", render);
            document
                .getElementById("btn-grid")
                .addEventListener("click", toggleGrid);
            document
                .getElementById("btn-expok")
                .addEventListener("click", doExport);
            document.getElementById("btn-png").addEventListener("click", () => {
                ST.expType = "png";
                showModal();
            });
            document.getElementById("btn-pdf").addEventListener("click", () => {
                ST.expType = "pdf";
                showModal();
            });
            document
                .getElementById("btn-dbml")
                .addEventListener("click", expDBML);
            document
                .getElementById("btn-mysql")
                .addEventListener("click", () => {
                    ST.expType = "mysql";
                    showModal();
                });
            document
                .getElementById("btn-pgsql")
                .addEventListener("click", () => {
                    ST.expType = "pgsql";
                    showModal();
                });

            // G key shortcut
            document.addEventListener("keydown", (e) => {
                if (
                    e.key === "g" &&
                    !e.ctrlKey &&
                    !e.metaKey &&
                    document.activeElement.tagName !== "INPUT"
                )
                    toggleGrid();
            });

            // ══════════════════════════════════════════════
            // RESIZER
            // ══════════════════════════════════════════════
            const RSZ = document.getElementById("resizer"),
                EPL = document.getElementById("epanel");
            let isR = false;
            RSZ.addEventListener("mousedown", () => {
                isR = true;
                RSZ.classList.add("active");
                document.body.style.cssText =
                    "cursor:col-resize;user-select:none;";
            });
            document.addEventListener("mousemove", (e) => {
                if (!isR) return;
                const w = e.clientX;
                if (w > 260 && w < window.innerWidth - 260)
                    EPL.style.width = w + "px";
            });
            document.addEventListener("mouseup", () => {
                if (!isR) return;
                isR = false;
                RSZ.classList.remove("active");
                document.body.style.cssText = "";
                ED?.layout();
                redrawSVG();
            });

            // ══════════════════════════════════════════════
            // MONACO INIT  —  complete, no truncation
            // ══════════════════════════════════════════════
            require.config({
                paths: { vs: "https://unpkg.com/monaco-editor@0.44.0/min/vs" },
            });

            require(["vs/editor/editor.main"], function () {
                // Remove loading indicator
                const el = document.getElementById("eload");
                if (el) el.remove();

                try {
                    // ── Language ──
                    monaco.languages.register({ id: "dbml" });

                    monaco.languages.setLanguageConfiguration("dbml", {
                        comments: {
                            lineComment: "//",
                            blockComment: ["/*", "*/"],
                        },
                        brackets: [
                            ["{", "}"],
                            ["[", "]"],
                            ["(", ")"],
                        ],
                        autoClosingPairs: [
                            { open: "{", close: "}" },
                            { open: "[", close: "]" },
                            { open: "(", close: ")" },
                            { open: "'", close: "'", notIn: ["string"] },
                            { open: "`", close: "`" },
                            { open: '"', close: '"' },
                        ],
                        surroundingPairs: [
                            { open: "{", close: "}" },
                            { open: "[", close: "]" },
                            { open: "(", close: ")" },
                            { open: "'", close: "'" },
                            { open: "`", close: "`" },
                            { open: '"', close: '"' },
                        ],
                        indentationRules: {
                            increaseIndentPattern:
                                /^\s*(Table|Enum|TableGroup|indexes|checks)\b.*\{[^}]*$/,
                            decreaseIndentPattern: /^\s*\}/,
                        },
                    });

                    // ── Tokenizer ──
                    monaco.languages.setMonarchTokensProvider("dbml", {
                        defaultToken: "",
                        keywords: [
                            "Table",
                            "TableGroup",
                            "TablePartial",
                            "Ref",
                            "Enum",
                            "Project",
                            "Note",
                            "as",
                        ],
                        types: [
                            "integer",
                            "int",
                            "biginteger",
                            "bigint",
                            "smallinteger",
                            "smallint",
                            "tinyinteger",
                            "tinyint",
                            "varchar",
                            "char",
                            "text",
                            "longtext",
                            "mediumtext",
                            "tinytext",
                            "boolean",
                            "bool",
                            "float",
                            "double",
                            "real",
                            "decimal",
                            "numeric",
                            "date",
                            "time",
                            "datetime",
                            "timestamp",
                            "json",
                            "jsonb",
                            "uuid",
                            "blob",
                            "longblob",
                            "mediumblob",
                            "serial",
                            "bigserial",
                        ],
                        constraints: [
                            "pk",
                            "unique",
                            "null",
                            "increment",
                            "default",
                            "ref",
                            "note",
                            "cascade",
                            "restrict",
                            "indexes",
                            "headercolor",
                            "delete",
                            "update",
                            "primary",
                            "key",
                            "not",
                            "database_type",
                        ],
                        tokenizer: {
                            root: [
                                [/\/\/.*$/, "comment"],
                                [
                                    /\/\*/,
                                    { token: "comment.block", next: "@bc" },
                                ],
                                [
                                    /[a-zA-Z_]\w*/,
                                    {
                                        cases: {
                                            "@keywords": "keyword",
                                            "@types": "type.identifier",
                                            "@constraints": "keyword.control",
                                            "@default": "identifier",
                                        },
                                    },
                                ],
                                [/"[^"]*"/, "string"],
                                [/'[^']*'/, "string"],
                                [/`[^`]*`/, "string.escape"],
                                [/#[0-9a-fA-F]{3,8}\b/, "constant.regexp"],
                                [/\d+(\.\d+)?/, "number"],
                                [/[{}\[\]()]/, "delimiter.bracket"],
                                [/[<>\-]{1,2}/, "keyword.operator"],
                                [/[:,.]/, "delimiter"],
                            ],
                            bc: [
                                [/[^\/*]+/, "comment.block"],
                                [
                                    /\/\*/,
                                    { token: "comment.block", next: "@push" },
                                ],
                                [
                                    /\*\//,
                                    { token: "comment.block", next: "@pop" },
                                ],
                                [/[\/*]/, "comment.block"],
                            ],
                        },
                    });

                    // ── Completions ──
                    monaco.languages.registerCompletionItemProvider("dbml", {
                        triggerCharacters: [" ", "[", ":", "\n"],
                        provideCompletionItems: function (model, position) {
                            var tu = model.getValueInRange({
                                startLineNumber: position.lineNumber,
                                startColumn: 1,
                                endLineNumber: position.lineNumber,
                                endColumn: position.column,
                            });
                            var wd = model.getWordUntilPosition(position);
                            var rng = {
                                startLineNumber: position.lineNumber,
                                endLineNumber: position.lineNumber,
                                startColumn: wd.startColumn,
                                endColumn: wd.endColumn,
                            };
                            var isLS = /^\s*$/.test(
                                tu.slice(0, wd.startColumn - 1),
                            );
                            var isIB = /\[[^\]]*$/.test(tu);
                            var KW =
                                monaco.languages.CompletionItemKind.Keyword;
                            var TY =
                                monaco.languages.CompletionItemKind
                                    .TypeParameter;
                            var PR =
                                monaco.languages.CompletionItemKind.Property;
                            var SN =
                                monaco.languages.CompletionItemKind.Snippet;
                            var IR =
                                monaco.languages.CompletionItemInsertTextRule
                                    .InsertAsSnippet;
                            var s = [];
                            if (isLS) {
                                s.push({
                                    label: "Table",
                                    kind: SN,
                                    detail: "Define a table",
                                    insertText:
                                        "Table ${1:name} {\n  ${2:id} integer [pk, increment]\n  $0\n}",
                                    insertTextRules: IR,
                                    range: rng,
                                });
                                s.push({
                                    label: "Ref",
                                    kind: SN,
                                    detail: "Relationship",
                                    insertText:
                                        "Ref: ${1:t1}.${2:col} > ${3:t2}.${4:id}",
                                    insertTextRules: IR,
                                    range: rng,
                                });
                                s.push({
                                    label: "Enum",
                                    kind: SN,
                                    detail: "Enum type",
                                    insertText:
                                        "Enum ${1:name} {\n  ${2:val1}\n  $0\n}",
                                    insertTextRules: IR,
                                    range: rng,
                                });
                                s.push({
                                    label: "Project",
                                    kind: SN,
                                    detail: "Project metadata",
                                    insertText:
                                        "Project ${1:name} {\n  database_type: '${2:PostgreSQL}'\n  Note: '${3:desc}'\n}",
                                    insertTextRules: IR,
                                    range: rng,
                                });
                                s.push({
                                    label: "TableGroup",
                                    kind: KW,
                                    insertText: "TableGroup",
                                    range: rng,
                                });
                                s.push({
                                    label: "Note",
                                    kind: KW,
                                    insertText: "Note",
                                    range: rng,
                                });
                            }
                            if (!isLS && !isIB) {
                                [
                                    ["integer", "INT/INTEGER"],
                                    ["biginteger", "BIGINT"],
                                    ["smallinteger", "SMALLINT"],
                                    ["varchar(255)", "VARCHAR"],
                                    ["varchar(100)", "VARCHAR"],
                                    ["text", "TEXT"],
                                    ["boolean", "BOOL"],
                                    ["float", "FLOAT"],
                                    ["double", "DOUBLE PRECISION"],
                                    ["decimal(10,2)", "DECIMAL"],
                                    ["date", "DATE"],
                                    ["time", "TIME"],
                                    ["datetime", "DATETIME"],
                                    ["timestamp", "TIMESTAMP"],
                                    ["json", "JSON/JSONB"],
                                    ["uuid", "UUID/CHAR(36)"],
                                    ["blob", "BLOB/BYTEA"],
                                ].forEach(function (x) {
                                    s.push({
                                        label: x[0],
                                        kind: TY,
                                        detail: x[1],
                                        insertText: x[0],
                                        range: rng,
                                    });
                                });
                            }
                            if (isIB) {
                                [
                                    ["pk", "Primary key", "pk"],
                                    [
                                        "primary key",
                                        "Primary key",
                                        "primary key",
                                    ],
                                    ["unique", "Unique", "unique"],
                                    ["not null", "Not null", "not null"],
                                    ["null", "Allow null", "null"],
                                    [
                                        "increment",
                                        "Auto-increment",
                                        "increment",
                                    ],
                                    [
                                        "default: `now()`",
                                        "Default now()",
                                        "default: `now()`",
                                    ],
                                    ["default: 0", "Default 0", "default: 0"],
                                    [
                                        "default: ''",
                                        "Default empty",
                                        "default: ''",
                                    ],
                                    [
                                        "ref: >",
                                        "Many-to-one",
                                        "ref: > ${1:table}.${2:id}",
                                    ],
                                    [
                                        "ref: <",
                                        "One-to-many",
                                        "ref: < ${1:table}.${2:id}",
                                    ],
                                    [
                                        "ref: -",
                                        "One-to-one",
                                        "ref: - ${1:table}.${2:id}",
                                    ],
                                    [
                                        "ref: <>",
                                        "Many-to-many",
                                        "ref: <> ${1:table}.${2:id}",
                                    ],
                                    [
                                        "note: ''",
                                        "Column note",
                                        "note: '${1:desc}'",
                                    ],
                                    [
                                        "headercolor:",
                                        "Header color",
                                        "headercolor: #${1:3498DB}",
                                    ],
                                ].forEach(function (x) {
                                    s.push({
                                        label: x[0],
                                        kind: PR,
                                        detail: x[1],
                                        insertText: x[2],
                                        insertTextRules:
                                            x[2].indexOf("${") === -1
                                                ? undefined
                                                : IR,
                                        range: rng,
                                    });
                                });
                            }
                            return { suggestions: s };
                        },
                    });

                    // ── Hover ──
                    monaco.languages.registerHoverProvider("dbml", {
                        provideHover: function (model, position) {
                            var w = model.getWordAtPosition(position);
                            if (!w) return null;
                            var D = {
                                integer: "**integer** → INT / INTEGER",
                                varchar: "**varchar(n)** → VARCHAR(n)",
                                boolean: "**boolean** → TINYINT(1) / BOOLEAN",
                                timestamp: "**timestamp** → TIMESTAMP",
                                uuid: "**uuid** → CHAR(36) / UUID",
                                json: "**json** → JSON / JSONB",
                                blob: "**blob** → BLOB / BYTEA",
                                increment:
                                    "**increment** → AUTO_INCREMENT / SERIAL",
                                pk: "**pk** — primary key",
                                unique: "**unique** — UNIQUE constraint",
                                default: "**default:** — default value",
                                ref: "**ref:** — foreign key reference",
                            };
                            var d = D[w.word.toLowerCase()];
                            if (d)
                                return {
                                    contents: [{ value: d }],
                                    range: {
                                        startLineNumber: position.lineNumber,
                                        endLineNumber: position.lineNumber,
                                        startColumn: w.startColumn,
                                        endColumn: w.endColumn,
                                    },
                                };
                            return null;
                        },
                    });

                    // ── Themes ──
                    monaco.editor.defineTheme("dbml-dark", {
                        base: "vs-dark",
                        inherit: true,
                        rules: [
                            {
                                token: "keyword",
                                foreground: "a78bfa",
                                fontStyle: "bold",
                            },
                            { token: "type.identifier", foreground: "fbbf24" },
                            { token: "keyword.control", foreground: "34d399" },
                            {
                                token: "comment",
                                foreground: "4e5d63",
                                fontStyle: "italic",
                            },
                            {
                                token: "comment.block",
                                foreground: "4e5d63",
                                fontStyle: "italic",
                            },
                            { token: "string", foreground: "f87171" },
                            { token: "string.escape", foreground: "fb923c" },
                            { token: "constant.regexp", foreground: "f472b6" },
                            { token: "number", foreground: "fb923c" },
                            { token: "delimiter", foreground: "6b7880" },
                            {
                                token: "delimiter.bracket",
                                foreground: "9ca3af",
                            },
                            { token: "keyword.operator", foreground: "60a5fa" },
                            { token: "identifier", foreground: "e2e8f0" },
                        ],
                        colors: {
                            "editor.background": "#1e2022",
                            "editor.foreground": "#e2e8f0",
                            "editor.lineHighlightBackground": "#252a2e",
                            "editor.selectionBackground": "#2d4a6e",
                            "editorLineNumber.foreground": "#3d4d55",
                            "editorLineNumber.activeForeground": "#7a8a93",
                            "editorCursor.foreground": "#32b8c6",
                            "editorWidget.background": "#252a2e",
                            "editorSuggestWidget.background": "#252a2e",
                            "editorSuggestWidget.border": "#3d4d55",
                            "editorSuggestWidget.selectedBackground": "#2d4a6e",
                        },
                    });

                    monaco.editor.defineTheme("dbml-light", {
                        base: "vs",
                        inherit: true,
                        rules: [
                            {
                                token: "keyword",
                                foreground: "7c3aed",
                                fontStyle: "bold",
                            },
                            { token: "type.identifier", foreground: "a16207" },
                            { token: "keyword.control", foreground: "047857" },
                            {
                                token: "comment",
                                foreground: "9ca3af",
                                fontStyle: "italic",
                            },
                            {
                                token: "comment.block",
                                foreground: "9ca3af",
                                fontStyle: "italic",
                            },
                            { token: "string", foreground: "dc2626" },
                            { token: "string.escape", foreground: "d97706" },
                            { token: "constant.regexp", foreground: "db2777" },
                            { token: "number", foreground: "d97706" },
                            { token: "delimiter", foreground: "6b7280" },
                            {
                                token: "delimiter.bracket",
                                foreground: "6b7280",
                            },
                            { token: "keyword.operator", foreground: "2563eb" },
                            { token: "identifier", foreground: "1e293b" },
                        ],
                        colors: {
                            "editor.background": "#ffffff",
                            "editor.foreground": "#1e293b",
                            "editor.lineHighlightBackground": "#f8fafc",
                            "editor.selectionBackground": "#dbeafe",
                            "editorLineNumber.foreground": "#d1d5db",
                            "editorLineNumber.activeForeground": "#9ca3af",
                            "editorCursor.foreground": "#21808d",
                            "editorWidget.background": "#f8fafc",
                            "editorSuggestWidget.background": "#ffffff",
                            "editorSuggestWidget.border": "#e2e8f0",
                            "editorSuggestWidget.selectedBackground": "#eff6ff",
                        },
                    });

                    // ── Create editor ──
                    ED = monaco.editor.create(document.getElementById("econ"), {
                        value: "",
                        language: "dbml",
                        theme: getMonacoTheme(),
                        minimap: { enabled: false },
                        lineNumbers: "on",
                        tabSize: 2,
                        insertSpaces: true,
                        wordWrap: "off",
                        scrollBeyondLastLine: false,
                        automaticLayout: true,
                        fontSize: 13,
                        fontFamily:
                            "'Cascadia Code','Fira Code','JetBrains Mono','Courier New',monospace",
                        fontLigatures: true,
                        lineHeight: 22,
                        padding: { top: 14, bottom: 14 },
                        scrollbar: {
                            verticalScrollbarSize: 6,
                            horizontalScrollbarSize: 6,
                        },
                        overviewRulerLanes: 0,
                        hideCursorInOverviewRuler: true,
                        overviewRulerBorder: false,
                        renderLineHighlight: "line",
                        contextmenu: true,
                        smoothScrolling: true,
                        cursorSmoothCaretAnimation: "on",
                        cursorBlinking: "smooth",
                        bracketPairColorization: { enabled: false },
                        renderWhitespace: "none",
                        suggest: {
                            showKeywords: true,
                            showSnippets: true,
                            showWords: false,
                        },
                        quickSuggestions: {
                            other: true,
                            comments: false,
                            strings: true,
                        },
                        suggestOnTriggerCharacters: true,
                        wordBasedSuggestions: false,
                        folding: true,
                        showFoldingControls: "mouseover",
                    });

                    // ── Editor events ──
                    ED.onDidChangeModelContent(function () {
                        render();
                        scheduleSave();
                        var errs = parseDBML(getVal()).errors;
                        document.getElementById("estatus").textContent =
                            errs.length
                                ? "\u26a0 " +
                                  errs.length +
                                  " error" +
                                  (errs.length > 1 ? "s" : "")
                                : "";
                    });

                    ED.onDidChangeCursorPosition(function (e) {
                        document.getElementById("s-cur").textContent =
                            "Ln " +
                            e.position.lineNumber +
                            ", Col " +
                            e.position.column;
                    });

                    window
                        .matchMedia("(prefers-color-scheme: dark)")
                        .addEventListener("change", function () {
                            if (ST.theme === "auto")
                                monaco.editor.setTheme(getMonacoTheme());
                        });

                    // Load from localStorage if available, otherwise load example
                    try {
                        const _saved = localStorage.getItem(LS_KEY);
                        if (_saved && _saved.trim()) {
                            ED.setValue(_saved);
                            render();
                        } else {
                            loadEx();
                        }
                    } catch (e) {
                        console.warn("DDS: localStorage read failed:", e);
                        loadEx();
                    }
                } catch (err) {
                    // Show error in editor area if init fails
                    document.getElementById("econ").innerHTML =
                        '<div style="padding:20px;color:var(--err);font-size:12px;font-family:monospace;background:var(--edbg);height:100%;overflow:auto">' +
                        "<strong>Monaco init failed:</strong><br>" +
                        err.message +
                        "<br><br><small>Try opening via a local web server instead of file://</small></div>";
                    console.error("Monaco init error:", err);
                }
            }); // end require — script complete
        </script>
    </body>
</html>
